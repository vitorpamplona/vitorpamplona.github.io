---
title: "Ferret, o Lucene do Ruby"
permalink: /wiki/Ferret, o Lucene do Ruby
redirect_from: 
  - "/wiki/Ferret,+o+Lucene+do+Ruby"
---

<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Strict//EN" "http://www.w3.org/TR/xhtml1/DTD/xhtml1-strict.dtd">
<html xmlns="http://www.w3.org/1999/xhtml" lang="en">

<head>
  <meta http-equiv="content-type" content="text/html; charset=utf-8" />
  <meta http-equiv="content-language" content="pt-BR,en-US">
  <meta name="copyright" content="Vitor Fernando Pamplona">
  <meta name="robots" content="follow">
  <meta name="revisit-after" content="3 days">
  <meta name="rating" content="general">
  <meta property="fb:admins" content="1352207037" />
  <meta name="verify-v1" content="PEmbDgMrDta4EuJW0kdAcwnNetOEgCFwPEg+108t7/E=" />

  <meta name="description" content=" Ferret é uma engine de indexação e pesquisa semelhante ao Lucene, porém produzida para mundo Ruby. Obviamente, esta engine já possui seu plugin para o Rails, o acts_as_ferret, assunto deste post. , Author: Vitor Fernando Pamplona" />
  <meta name="keywords" content="Vitor, Vitor Pamplona, Vitor Fernando Pamplona, Rails, Ruby, Java, C++, Mestrado, Doutorado, Engenharia de Software, Usabilidade, Efetividade, Boo, Carreira" />
  <meta name="author" content="Vitor Fernando Pamplona" />
  <link rel="alternate" type="application/rss+xml" title="Vitor Pamplona's Feed" href="http://vitorpamplona.com/lastChangesRss.pr" />
  


  <title>Ferret, o Lucene do Ruby :: Vitor Pamplona</title>

  <link rel="stylesheet" type="text/css" media="all" href="../interface/css/style.css" />

  <link rel="StyleSheet" href="../interface/includes/tree/dtree.css" type="text/css"> </link>
  <script type="text/javascript" src="../dtree.pr.html"></script>        


	<script class="javascript" src="http://vitorpamplona.com/deps/syntax/shCore.js"></script>
<script class="javascript" src="http://vitorpamplona.com/deps/syntax/shBrushJava.js"></script>
<script class="javascript" src="http://vitorpamplona.com/deps/syntax/shBrushRuby.js"></script>

<link href="http://vitorpamplona.com/deps/syntax/SyntaxHighlighter.css" type=text/css rel=stylesheet>

<script type="text/javascript">
var gaJsHost = (("https:" == document.location.protocol) ? "https://ssl." : "http://www.");
document.write(unescape("%3Cscript src='" + gaJsHost + "google-analytics.com/ga.js' type='text/javascript'%3E%3C/script%3E"));
</script>
<script type="text/javascript">
var pageTracker = _gat._getTracker("UA-1248613-2");
pageTracker._initData();
pageTracker._trackPageview();

function f_unload() {pageTracker._trackPageview("/endpage");}
window.onunload = f_unload;
</script>
      

<!-- Place this tag in your head or just before your close body tag -->
<script type="text/javascript" src="https://apis.google.com/js/plusone.js"></script>



<script language="JavaScript">
	function toggleVisibility(me){
   		el = document.getElementById(me);
		if (el.style.display=='none'){
			el.style.display='';
		} else {
			el.style.display='none';
		}
	}	
</script>
  
</head>

<body>

    <div class="page-container">
	
   
    <!-- Sitename and Banner -->
	<div class="site-name">
		 Vitor Pamplona
	</div>	
	  	<div class="site-slogan">
  <p>Innovation on Vision: <a href="http://eyenetra.com">Imaging</a> , <a href="http://tailoreddisplays.com">Enhancement</a> and <a href="http://vitorpamplona.com/wiki/Photorealistic%20Models%20for%20Pupil%20Light%20Reflex%20and%20Iridal%20Pattern%20Deformation">Simulation</a></p>
		</div>
		
    	<div class="nav-main nav-main-font">			
		<!-- Main Navigation -->
		<ul>
                



      	<li><a href="index.html"  class="selected" >Highlights</a></li>

		<li><a href="Papers.html"  class="selected" >Research Projects</a></li>



<li><a href="../tagIndex.pr.html" >
Personal Thoughts</a></li>

		<li><a href="http://www.twitter.com/vitorpamplona" >Live Updates</a></li>

		<li><a href="https://plus.google.com/101404049137638062356/posts">Shared Stories</a></li>

        	
                


    	  <li><a href="Curriculum.html">Curriculum</a></li>

		        	
        			
		
						
		</ul>
		
	</div>
	
	<div class="buffer"></div>

	<!-- WRAP CONTENT AND SIDEBAR -->
    <div class="container-content-sidebar-front">

	<!-- div class="left-menu">
	    <div class="left-sidebarbox-border bg-blue02">
	    	<div class="sidebarbox-title-shading bg-blue05">
	    	     Menu
	    	</div>
	    	
	    	<ul>
        	<li><a href="/wiki/"  class="selected" >Front Page</a></li>
        	<li><a href="/lastChanges.pr"  class="selected" >Blog</a></li>
        	<li><a href="/new.pr"  class="selected" >New Page</a></li>
			        	<li><a href="/showSignUp.pr"  class="selected" >Sign Up</a></li>        	
        	        		    	</ul>
	    </div>		
	</div -->
	<!-- Continue in index.vm -->      
	
		

<div class="content content-font">
		
	
		<div class="contentbox-full">	

	
			<div class="left-menu">	
																					
			

			</div>
				
						<!-- SIDEBAR -->		
	  		<div class="sidebar sidebar-font">
	  			
	  		
									
								
												
				

			</div>

			<h1 class="line-black"> Ferret, o Lucene do Ruby</h1> 

						        				


								<div class="contentbox-noshading">


<script async src="https://pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script>
<ins class="adsbygoogle"
     style="display:block; text-align:center;"
     data-ad-layout="in-article"
     data-ad-format="fluid"
     data-ad-client="ca-pub-7740443081675700"
     data-ad-slot="9560367159"></ins>
<script>
     (adsbygoogle = window.adsbygoogle || []).push({});
</script>


					<p> <a href="http://ferret.davebalmain.com/trac/" target="_blank">Ferret</a> é uma engine de indexação e pesquisa semelhante ao <a href="http://lucene.apache.org/">Lucene</a>, porém produzida para mundo Ruby. Obviamente, esta engine já possui seu plugin para o Rails, o <a href="http://projects.jkraemer.net/acts_as_ferret/wiki">acts_as_ferret</a>, assunto deste post. </p> <p> Para instalar o Ferret e seu plugin, faça: </p> <pre>sudo apt-get install ruby1.8-dev <br />sudo gem install ferret<br />sudo gem install acts_as_ferret</pre> <p> Vá até a pasta do seu projeto e baixe o plugin: </p> <pre>script/plugin install svn://projects.jkraemer.net/acts_as_ferret/tags/stable/acts_as_ferret </pre> <p> Pronto. Para utilizar, declare em cada classe do seu modelo, quais campos devem ser indexados, desta maneira: </p> <pre>class Member &lt; ActiveRecord::Base<br />  acts_as_ferret :fields =&gt; [:first_name, :last_name]<br />end <br /></pre> <p> O Ferret indexará os campos <em> first_name </em> e <em> last_name </em>, incluindo ambos em suas consultas. Nesta parte pode ser <a href="http://projects.jkraemer.net/acts_as_ferret/wiki/AdvancedUsage">configurado uma série de parâmetros para o Ferret</a>, desde pesos para cada atributo (boost) até formas de indexação e algumas gambiarras. </p> <p> Para efetuar uma pesquisa, basta fazer: </p> <pre>total_results, members = Member.find_id_by_contents("Gregg") </pre> <p> O <em> total_results </em> terá o número de registros retornados e o members terá uma estrutura semelhante a essa: </p> <pre>members = [<br />         {:model =&gt; "Member", :id =&gt; "4", :score =&gt; "1.0"}, <br />         {:model =&gt; "Member", :id =&gt; "21", :score =&gt; "0.93211"}, <br />         {:model =&gt; "Member", :id =&gt; "27", :score =&gt; "0.32212"}<br />]</pre> <p> O <em> score </em> é o índice de relacionamento entre as suas palavras-chave e o registro que retornou. Quanto maior o índice, aumenta a probabilidade de ser o registro procurado. </p> <p> Se você deseja retornar os objetos ao invés dos <em> ids </em>, basta fazer: </p> <pre>@results = Member.find_by_contents("Gregg") </pre> <p> Tanto o <em> find_by_contents </em> quanto o <em> find_id_by_contents </em> <a href="http://projects.jkraemer.net/rdoc/acts_as_ferret/classes/ActsAsFerret/ClassMethods.html#M000040">possibilitam o envio de opções</a>, por exemplo, recursos de paginação para pesquisas mono-modelo. </p> <h2> Procurando em múltiplos modelos </h2> <p> Algumas vezes é necessário fazer uma única pesquisa em várias classes de modelo, nas qual seus relacionamentos são desconsiderados. A resposta da consulta é um array que pode conter diferentes classes de dados e, portanto, devem ser trabalhadas para uma vizualização correta. </p> <p> Para tal, altere o environment.rb, adicionando as classes modelo que serão alvo da pesquisa: </p> <pre>FERRETABLE_MODELS = %w[Members Classe1 Classe2 Classe3 Classe4] </pre> <p> Cada nova classe criada, se ela pertencer a pesquisa, deve ser adicionada neste array. </p> <p> Após, crie um formulário para a pesquisa: </p> <pre>&lt;h1&gt;Pesquise a vontade!&lt;/h1&gt;<br />&lt;p&gt;<br /><br />&lt;% form_tag :action =&gt; "search" do %&gt;<br />  &lt;p&gt;<br />    &lt;label&gt;Pesquisa: &lt;/label&gt;<br />    &lt;%= text_field_tag 'searching' %&gt;<br />  &lt;/p&gt;<br />  &lt;p&gt;&lt;%= submit_tag 'pesquisar' %&gt;&lt;/p&gt;<br />&lt;% end %&gt;<br />&lt;/p&gt;</pre> <p> e na action correspondente, adicione: </p> <pre>results = []<br />@total_hits = 0;<br />FERRETABLE_MODELS.each do |klass|<br />  k = Kernel.const_get klass<br />  k.find_by_contents(params[:searching]).each do |m|<br />    results.push m <br />    @total_hits += 1;<br />  end<br />end<br />        <br />@members = results.sort{ |a,b| b.ferret_score &lt;=&gt; a.ferret_score } <br /></pre> <p> Este método buscará, em cada classe listada no array <em> FERRETABLE_MODELS </em>, os registros que se encaixem com a pesquisa e os colocará dentro do mesmo array. Em seguida, o array é ordenado pelo score da pesquisa de maneira decrescente. </p> <p> Agora basta criar uma view para o <em> members </em>. </p> <pre>&lt;h1&gt;A pesquisa retornou &lt;%=h @total_hits %&gt; registros&lt;/h1&gt;<br /><br />&lt;table class="list"&gt;<br />  &lt;tr&gt;<br />    &lt;th&gt;Cadastro&lt;/th&gt;<br />    &lt;th&gt;Registro&lt;/th&gt;<br />    &lt;th&gt;Ranking&lt;/th&gt;<br />  &lt;/tr&gt;<br /><br />&lt;% for result in @members %&gt;<br />  &lt;tr&gt;<br />    &lt;td&gt;&lt;%= link_to result.class.to_s, {:controller =&gt; result.class.to_s.underscore.pluralize, :action =&gt; :index} %&gt;&lt;/td&gt;<br />    &lt;td&gt;&lt;%= link_to result.to_search_view, {:controller =&gt; result.class.to_s.underscore.pluralize, :action =&gt; :show, :id =&gt; result.id} %&gt;&lt;/td&gt;    <br />    &lt;td&gt;&lt;%=h result.ferret_score %&gt;&lt;/td&gt;<br />  &lt;/tr&gt;<br />&lt;% end %&gt;<br />&lt;/table&gt;</pre> <h2> Paginando resultados da consulta em múltiplos modelos </h2> <p> Primeiramente, instale o plugin <a href="http://cardboardrocket.com/pages/paginating_find">paginating_find</a>: </p> <pre>script/plugin install http://svn.cardboardrocket.com/paginating_find </pre> <p> Após, altere a action search, descrita na última seção, para: </p> <pre>def search<br />  @searching = params[:searching]<br />    params[:page] = 1 if (params[:page].to_i &lt; 1)<br />        <br />    results = []<br />    @total_hits = 0;<br />    FERRETABLE_MODELS.each do |klass|<br />        k = Kernel.const_get klass<br />        k.find_by_contents(@searching).each do |m|<br />          results.push m <br />          @total_hits += 1;<br />        end<br />    end<br />        <br />    @members = results.sort{ |a,b| b.ferret_score &lt;=&gt; a.ferret_score }<br />    page_size = 20 <br />    <br />    @pageEnumerator = PagingEnumerator.new(page_size, @total_hits, false, params[:page], 1) do |page|<br />        offset = (params[:page].to_i - 1) * page_size <br />        limit = page_size<br />        @members[offset..limit+offset-1]<br />    end<br />end </pre> <p> Repare que agora temos: </p> <ol> <li> uma variável de classe para armazenar a query. Esta informação é necessária para manter a query nas trocas de página. </li> <li> um novo parâmetro chamado: page que conterá o número da página em exibição. </li> <li> e um PageEnumerator, estrutura que é responsável por mostrar apenas os dados referente a página desejada. <br /> </li> </ol> <p> A view, deve ser alterada para: </p> <pre>&lt;h1&gt;A pesquisa retornou &lt;%=h @total_hits %&gt; registros&lt;/h1&gt;<br /><br />&lt;table class="list"&gt;<br />  &lt;tr&gt;<br />    &lt;th&gt;Cadastro&lt;/th&gt;<br />    &lt;th&gt;Registro&lt;/th&gt;<br />    &lt;th&gt;Ranking&lt;/th&gt;<br />  &lt;/tr&gt;<br /><br />&lt;% for result in @pageEnumerator %&gt;<br />  &lt;tr&gt;<br />    &lt;td&gt;&lt;%= link_to result.class.to_s, {:controller =&gt; result.class.to_s.underscore.pluralize, :action =&gt; :index} %&gt;&lt;/td&gt;<br />    &lt;td&gt;&lt;%= link_to result.to_search_view, {:controller =&gt; result.class.to_s.underscore.pluralize, :action =&gt; :show, :id =&gt; result.id} %&gt;&lt;/td&gt;    <br />    &lt;td&gt;&lt;%=h result.ferret_score %&gt;&lt;/td&gt;<br />  &lt;/tr&gt;<br />&lt;% end %&gt;<br />&lt;/table&gt;<br />&lt;div class="pagination"&gt;Páginas: &lt;%= paginating_links(@pageEnumerator, :params =&gt; {:searching =&gt; @searching}) %&gt;&lt;/div&gt; <br /></pre> <p> Repare agora que os dados são listados através do @ pageEnumerator e não mais do @ members e que a função paginating_links produzirá os links das páginas. Basta clicar num deles para que a página seja exibida. </p> <p> Fontes: <a href="http://www.railsenvy.com/2007/2/19/acts-as-ferret-tutorial" target="_blank">http://www.railsenvy.com/2007/2/19/acts-as-ferret-tutorial</a>, <a href="http://infovore.org/tag/ferret" target="_blank">http://infovore.org/tag/ferret</a> e <a href="http://projects.jkraemer.net/acts_as_ferret/rdoc">API documentation</a>. </p>


					
<script async src="https://pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script>
<ins class="adsbygoogle"
     style="display:block; text-align:center;"
     data-ad-layout="in-article"
     data-ad-format="fluid"
     data-ad-client="ca-pub-7740443081675700"
     data-ad-slot="9560367159"></ins>
<script>
     (adsbygoogle = window.adsbygoogle || []).push({});
</script>
                                <div>
                                        <p  class="postedBy">Posted in Feb 23, 2008 by <a href="../userHistory.pr%3FpostUser=vfpamp.html">Vitor Pamplona</a> -

                                                                                                                                                <a href="../edit.pr%3Fkeyword=Ferret,%2520o%2520Lucene%2520do%2520Ruby.html">Edit</a> -
                                                                                        
                                        <a href="../history.pr%3Fkeyword=Ferret,%2520o%2520Lucene%2520do%2520Ruby.html">History</a>
                                        					</p>
                                </div>
				</div>
				
				

					</div>
			
		
	<div id="fb-root"></div>
<script>
(function(d, s, id) {
  var js, fjs = d.getElementsByTagName(s)[0];
  if (d.getElementById(id)) {return;}
  js = d.createElement(s); js.id = id;
  js.src = "//connect.facebook.net/en_US/all.js#xfbml=1";
  fjs.parentNode.insertBefore(js, fjs);
}(document, 'script', 'facebook-jssdk'));
</script> 

<script type="text/javascript">
String.prototype.endsWith = function(suffix) {
    return this.indexOf(suffix, this.length - suffix.length) !== -1;
};

var url = window.location.href;
if (url.indexOf("Front%20Page") < 0  && url.indexOf("wiki/;jsessionid") < 0 && url.indexOf("lastChanges") < 0 && !url.endsWith("/wiki/")) {
   document.write('<div class="fb-comments" style="margin-left: 15px; border-bottom: solid 1px #546F90;" data-href="' + url + '" data-num-posts="10" data-width="800"></div>');
}
</script>             

	
					<div class="contentbox-full">
       			
			
</div>				

<div class="contentbox-full">
		<div id="divComment2"  style="display: none;">
		<a href="javascript:toggleVisibility('divComment');toggleVisibility('divComment2');">Add New Comment</a>
	</div>
	<h1>Add New Comment</h1>
	<div id="divComment">
		<form id="edit" name="edit" method="post" action="http://www.vitorpamplona.com/postComment.pr">
			<input type="hidden" name="keyword" value="Ferret, o Lucene do Ruby" />
			<p><textarea style="width:96%" name="commentOnlyText" id="commentOnlyText" rows=10></textarea></p>
							<p>Your Name: <input type="text" name="postUserName" value="" /></p>
						<p>
<img src="http://www.vitorpamplona.com/flood.jpg" /><br>
Write the code showed above on the text below.
<br>
<input class="inputText" type="text" id="floodValidation" name="floodValidation" value="" size=20/>
</p>
<p></p>			<p><input type="submit" name="Save" value="Save"></p>	
			<br>
		</form>	
	</div>
</div>	
				
	<script class='javascript'>  
 //<![CDATA[  
if (! window.ActiveXObject ) {
     function FindTagsByName(container, Tag)  
     {  
         var elements = document.getElementsByTagName(Tag);  
         for (var i = 0; i < elements.length; i++)  
         { 
		 if (elements[i].innerHTML.indexOf("def ") > -1
		 ||  elements[i].innerHTML.indexOf("ActiveR") > -1
		 ||  elements[i].innerHTML.indexOf("find_by") > -1	
                 ||  elements[i].innerHTML.indexOf(" => ") > -1
		 ) 
		    elements[i].setAttribute("class", "java");
                 else
		    elements[i].setAttribute("class","java");
		 elements[i].setAttribute("name", "code");
		 elements[i].setAttribute("id", "code");
                 container.push(elements[i]);  
         }  
     }  
     var elements = [];  
     FindTagsByName(elements, "pre");  

  for(var i=0; i < elements.length; i++) {  
   if(elements[i].nodeName.toUpperCase() == "PRE") {  
    brs = elements[i].getElementsByTagName("br");  
    for(var j = 0, brLength = brs.length; j < brLength; j++) {  
       var newNode = document.createTextNode("\n");  
       elements[i].replaceChild(newNode,brs[0]);  
    }  
   }  
  }  

}

   dp.SyntaxHighlighter.HighlightAll("code", false, false);  
 //]]>  
</script>     
		

    <!-- FOOTER -->
    <div class="postedBy"></div>

    <div class="footer footer-font">
       <p><b>Copyright ©Vitor Pamplona | All Rights Reserved</b>  
       <br>Powered by <a href="http://wiki.com.br">Priki</a>. Visite os projetos: <a href="http://eyenetra.com">EyeNetra.com</a> e <a href="http://goblink.co">goBlink.co</a>.   

				- <a href="../showLogin.pr.html" class="selected">Login</a>
        	        	
	</p>
    </div>
  </div>
</body>
</html>
