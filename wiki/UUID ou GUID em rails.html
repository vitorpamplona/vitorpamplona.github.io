---
title: "UUID ou GUID em rails"
permalink: "/wiki/UUID ou GUID em rails"
redirect_from: 
  - "/wiki/UUID+ou+GUID+em+rails"
---

<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Strict//EN" "http://www.w3.org/TR/xhtml1/DTD/xhtml1-strict.dtd">
<html xmlns="http://www.w3.org/1999/xhtml" lang="en">

<head>
  <meta http-equiv="content-type" content="text/html; charset=utf-8" />
  <meta http-equiv="content-language" content="pt-BR,en-US">
  <meta name="copyright" content="Vitor Fernando Pamplona">
  <meta name="robots" content="follow">
  <meta name="revisit-after" content="3 days">
  <meta name="rating" content="general">
  <meta property="fb:admins" content="1352207037" />
  <meta name="verify-v1" content="PEmbDgMrDta4EuJW0kdAcwnNetOEgCFwPEg+108t7/E=" />

  <meta name="description" content=" UUID (Universally Unique Identifier) ou GUID (Globally Unique Identifier) são técnicas de identificação de registros globais, ou seja, os seus registros recebem um id de forma que não existirá outro no mundo com o mesmo (probabilidade muito baixa de acontecer). , Author: Vitor Fernando Pamplona" />
  <meta name="keywords" content="Vitor, Vitor Pamplona, Vitor Fernando Pamplona, Rails, Ruby, Java, C++, Mestrado, Doutorado, Engenharia de Software, Usabilidade, Efetividade, Boo, Carreira" />
  <meta name="author" content="Vitor Fernando Pamplona" />
  <link rel="alternate" type="application/rss+xml" title="Vitor Pamplona's Feed" href="http://vitorpamplona.com/lastChangesRss.pr" />
  


  <title>UUID ou GUID em rails :: Vitor Pamplona</title>

  <link rel="stylesheet" type="text/css" media="all" href="../interface/css/style.css" />

  <link rel="StyleSheet" href="../interface/includes/tree/dtree.css" type="text/css"> </link>
  <script type="text/javascript" src="../dtree.pr.html"></script>        


	<script class="javascript" src="http://vitorpamplona.com/deps/syntax/shCore.js"></script>
<script class="javascript" src="http://vitorpamplona.com/deps/syntax/shBrushJava.js"></script>
<script class="javascript" src="http://vitorpamplona.com/deps/syntax/shBrushRuby.js"></script>

<link href="http://vitorpamplona.com/deps/syntax/SyntaxHighlighter.css" type=text/css rel=stylesheet>

<script type="text/javascript">
var gaJsHost = (("https:" == document.location.protocol) ? "https://ssl." : "http://www.");
document.write(unescape("%3Cscript src='" + gaJsHost + "google-analytics.com/ga.js' type='text/javascript'%3E%3C/script%3E"));
</script>
<script type="text/javascript">
var pageTracker = _gat._getTracker("UA-1248613-2");
pageTracker._initData();
pageTracker._trackPageview();

function f_unload() {pageTracker._trackPageview("/endpage");}
window.onunload = f_unload;
</script>
               
	<style>
#pageshare {
  position:fixed; 
  top:15%; 
  margin-left:-90px; 
  float:left; 
  border-radius:5px;-moz-border-radius:5px;-webkit-border-radius:5px;
  padding:0 0 2px 0;

}
#pageshare .sbutton {float:left;clear:both;margin:5px 5px 0 5px;}
.fb_share_count_top {width:48px !important;}
.fb_share_count_top, .fb_share_count_inner {-moz-border-radius:3px;-webkit-border-radius:3px;}
.FBConnectButton_Small, .FBConnectButton_RTL_Small {width:49px !important; -moz-border-radius:3px;/*bs-fsmsb*/-webkit-border-radius:3px;}
.FBConnectButton_Small .FBConnectButton_Text {padding:2px 2px 3px !important;-moz-border-radius:3px;-webkit-border-radius:3px;font-size:8px;}
</style>        

<!-- Place this tag in your head or just before your close body tag -->
<script type="text/javascript" src="https://apis.google.com/js/plusone.js"></script>



<script language="JavaScript">
	function toggleVisibility(me){
   		el = document.getElementById(me);
		if (el.style.display=='none'){
			el.style.display='';
		} else {
			el.style.display='none';
		}
	}	
</script>
  
</head>

<body>

    <div class="page-container">
	
   
    <!-- Sitename and Banner -->
	<div class="site-name">
		 Vitor Pamplona
	</div>	
	  	<div class="site-slogan">
  <p>Innovation on Vision: <a href="http://eyenetra.com">Imaging</a> , <a href="http://tailoreddisplays.com">Enhancement</a> and <a href="http://vitorpamplona.com/wiki/Photorealistic%20Models%20for%20Pupil%20Light%20Reflex%20and%20Iridal%20Pattern%20Deformation">Simulation</a></p>
		</div>
		
    	<div class="nav-main nav-main-font">			
		<!-- Main Navigation -->
		<ul>
                



      	<li><a href="index.html"  class="selected" >Highlights</a></li>

		<li><a href="Papers.html"  class="selected" >Research Projects</a></li>



<li><a href="../tagIndex.pr.html" >
Personal Thoughts</a></li>

		<li><a href="http://www.twitter.com/vitorpamplona" >Live Updates</a></li>

		<li><a href="https://plus.google.com/101404049137638062356/posts">Shared Stories</a></li>

        	
                


    	  <li><a href="Curriculum.html">Curriculum</a></li>

		        	
        			
		
						
		</ul>
		
	</div>
	
	<div class="buffer"></div>

	<!-- WRAP CONTENT AND SIDEBAR -->
    <div class="container-content-sidebar-front">

	<!-- div class="left-menu">
	    <div class="left-sidebarbox-border bg-blue02">
	    	<div class="sidebarbox-title-shading bg-blue05">
	    	     Menu
	    	</div>
	    	
	    	<ul>
        	<li><a href="/wiki/"  class="selected" >Front Page</a></li>
        	<li><a href="/lastChanges.pr"  class="selected" >Blog</a></li>
        	<li><a href="/new.pr"  class="selected" >New Page</a></li>
			        	<li><a href="/showSignUp.pr"  class="selected" >Sign Up</a></li>        	
        	        		    	</ul>
	    </div>		
	</div -->
	<!-- Continue in index.vm -->      
	
		

<div class="content content-font">
		
	
		<div class="contentbox-full">	

	
			<div class="left-menu">	
																					
			

			</div>
				
						<!-- SIDEBAR -->		
	  		<div class="sidebar sidebar-font">
	  			
	  		
									
								
												
				

			</div>

			<h1 class="line-black"> UUID ou GUID em rails</h1> 

						        				


								<div class="contentbox-noshading">





					<p> UUID (Universally Unique Identifier) ou <a href="http://en.wikipedia.org/wiki/Globally_Unique_Identifier" target="_blank">GUID</a> (Globally Unique Identifier) são técnicas de identificação de registros globais, ou seja, os seus registros recebem um id de forma que não existirá outro no mundo com o mesmo (probabilidade muito baixa de acontecer). </p> <p> Na prática, este tipo de identificação é muito útil para evitar problemas de segurança e evitar que softwares mal intencionados encontrem registros desprotegidos. Por exemplo, se você recebe um e-mail com id = 5600, você pode assumir que existem outros 5599 e-mails, e pode tentar acessá-los simplesmente mudando a url. Porém, se você receber um e-mail com id = 11885-6c7f0bd17f, como o gmail faz, encontrar outro e-mail é algo computacionalmente custoso. </p> <p> Em ruby, existe um gem que calcula este " hash " chamado <a href="http://sporkmonger.com/projects/uuidtools/">uuidtools</a>. Para integrá-lo ao rails, você pode fazer <a href="http://codesnipers.com/?q=node/143&title=Using-UUID/GUID-as-Primary-Key-in-Rails" target="_blank">na mão</a>, ou baixar o <a href="http://tools.assembla.com/breakout/wiki/FreeSoftware" target="_blank">plugin</a>: </p> <pre>script/plugin install http://tools.assembla.com/svn/breakout/breakout/vendor/plugins/guid </pre> <p> Inclua a chamada de função a usesguid em cada classe do seu modelo: </p> <pre>class Mymodel &lt; ActiveRecord::Base<br />    usesguid <br /></pre> <p> Altere suas migrations, adicionando a opção id igual a false na função create_table e uma nova coluna: id como string. Lembre-se, também, de alterar todas as referências (FKs) para strings. </p> <pre class="wiki">create_table :mytable, :id =&gt; false do |t|<br />  t.column :id, :string, :limit =&gt; 22<br />  ... more fields<br />end      </pre> <p> Se você não puder alterar as migrations terá um sério problema na migração dos dados. </p> <p> Depois destas alterações, teoricamente, tudo deveria funcionar. Porém, não é bem assim. </p> <h2> Rails + GUID + PostgreSQL </h2> <p> Por convenção do banco de dados, o PostgreSQL não aceita comparar tipos diferentes. No caso do id ser um varchar, esta consulta retorna um erro: </p> <pre>select * from something where id = 12345 </pre> <p> O select deveria ficar assim </p> <pre>select * from something where id = '12345' <br /></pre> <p> Se a mesma consulta errada for feita em Oracle, ela roda, mas você quebra o índice, tornando as consultas bem lentas. Quando tentei validar os testes, uma série de erros relacionando o find e este tipo de consulta foram reportados. Descobri que estavam relacionadas as fixtures. </p> <p> Por exemplo, a fixture abaixo: </p> <pre>one:<br />  id: 1<br />  descricao: MyString1<br />  outra_tabela_id: 1 <br /></pre> <p> Os campos id e outra_tabela_id são entendidos como integers pelo ruby, logo pelo rails e em consequência, pelo método find, que irá gerar uma sql parecida com aquela errada demonstrada acima. </p> <p> Solução? Adicione alguns caracteres nos campos ID, só para serem interpretados como String, ao invés de integer: </p> <pre>one:<br />  id: M1<br />  descricao: MyString1<br />  outra_tabela_id: M1 </pre> <h2> O Erro do Mac Address </h2> <p> Ao executar os testes novamente me deparei com a seguinte mensagem de erro, que estava sendo disparada pela uuidtools: </p> <pre>NoMethodError: You have a nil object when you didn't expect it!<br />You might have expected an instance of Array.<br />The error occurred while evaluating nil.split<br />    /home/vfpamplona/workspaceRuby/xx/vendor/plugins/guid/lib/uuidtools.rb:236:in `timestamp_create'<br />    /home/vfpamplona/workspaceRuby/xx/vendor/plugins/guid/lib/uuidtools.rb:226:in `synchronize'<br />    /home/vfpamplona/workspaceRuby/xx/vendor/plugins/guid/lib/uuidtools.rb:226:in `timestamp_create'<br /></pre> <p> Se você procurar pela linha, ela vai apontar para uma função get_mac_address, que estará retornando nil. Ainda não entendi porque, apenas nos testes, o ruby não consegue buscar o endereço mac da placa de rede. A solução é setar um endereço mac default na mão mesmo. Abra o uuidtools.rb, dentro da pasta do plugin, e altere a linha: </p> <pre>@@mac_address = nil</pre> <p> para um endereço mac válido, exemplo: </p> <pre>@@mac_address = "00:1b:63:1e:b2:da" </pre> <h2> Automatizando mais! </h2> <p> Se você desejar transformar o ID para GUID / UUID em todos os modelos, sem exceção, você pode, simplesmente, alterar o usesguid.rb do plugin, adicionando a linha 3: </p> <pre>ActiveRecord::Base.class_eval do<br />  include ActiveRecord::Usesguid<br />  usesguid<br />end <br /></pre> <p> Mas, se fizer isso, você também precisa que todas as suas tabelas tenham um id default como VARCHAR (22). Isto pode ser feito utilizando os alias do rails. Crie um módulo chamado TableDefinition.rb e digite: </p> <pre>module TableDefinition<br />  def self.included(base)<br />    base.class_eval do<br />      alias_method_chain :create_table , :uuid_create_table<br />    end<br />  end<br /><br />  # Change the defaults of create table. <br />  # Instead of a sequenced primary key, <br />  # it creates an id with string(22) and an it's index <br />  def create_table_with_uuid_create_table(table_name, options = {}, &block)<br />    options[:id] = false<br />    create_table_without_uuid_create_table(table_name, options) do |table_defintion|<br />      table_defintion.column :id, 'varchar(22) primary key'<br />      yield table_defintion<br />    end<br />  end<br />end </pre> <p> O alias_method_chain redirecionará todas as chamadas da função create_table para a create_table_with_uuid_create_table e criará uma nova função create_table_without_uuid_create_table para permitir uma chamada ao create_table original. O código da nova função faz exatamente o que deveríamos fazer para instalar o plugin, seta o id default para false e adiciona uma coluna id. Note que aqui não estamos utilizando o tipo string, mas sim passando o tipo direto ao banco de dados. Desta forma, garantimos que o índice seja criado, e que o campo seja not_null. </p> <p> Adicione esta linha ao final do arquivo usesuid.rb para mesclar o módulo criado com o existente: </p> <pre>ActiveRecord::ConnectionAdapters::SchemaStatements::send(:include, TableDefinition)</pre> <p> E pronto, agora você não precisa mais aterar nenhuma PK das suas migrations, apenas as FKs. </p> <p> Lembrando que: não foi necessário alterar nenhum código da aplicação, apenas as fixtures. </p>


					
<script type="text/javascript"><!--
google_ad_client = "pub-7740443081675700";
/* 728x90, criado 06/04/10 */
google_ad_slot = "4989522421";
google_ad_width = 728;
google_ad_height = 90;
//-->
</script>
<div id="ads"><script type="text/javascript" src="http://pagead2.googlesyndication.com/pagead/show_ads.js"> </script></div>


                                <div>
                                        <p  class="postedBy">Posted in Mar 7, 2008 by <a href="../userHistory.pr%3FpostUser=vfpamp.html">Vitor Pamplona</a> -

                                                                                                                                                <a href="../edit.pr%3Fkeyword=UUID%2520ou%2520GUID%2520em%2520rails.html">Edit</a> -
                                                                                        
                                        <a href="../history.pr%3Fkeyword=UUID%2520ou%2520GUID%2520em%2520rails.html">History</a>
                                        					</p>
                                </div>
				</div>
				
				

					</div>
			
		
	<div id="fb-root"></div>
<script>
(function(d, s, id) {
  var js, fjs = d.getElementsByTagName(s)[0];
  if (d.getElementById(id)) {return;}
  js = d.createElement(s); js.id = id;
  js.src = "//connect.facebook.net/en_US/all.js#xfbml=1";
  fjs.parentNode.insertBefore(js, fjs);
}(document, 'script', 'facebook-jssdk'));
</script> 

<script type="text/javascript">
String.prototype.endsWith = function(suffix) {
    return this.indexOf(suffix, this.length - suffix.length) !== -1;
};

var url = window.location.href;
if (url.indexOf("Front%20Page") < 0  && url.indexOf("wiki/;jsessionid") < 0 && url.indexOf("lastChanges") < 0 && !url.endsWith("/wiki/")) {
   document.write('<div class="fb-comments" style="margin-left: 15px; border-bottom: solid 1px #546F90;" data-href="' + url + '" data-num-posts="10" data-width="800"></div>');
}
</script>             

	
					<div class="contentbox-full">
       		<h1 class="line-black">Showing Comments</h1> 
			
				<div class="contentbox-full-border">
			<div class="content-padding">
				<div class="contentbox-noshading">
					<p>velho vi seu post me interessou mto porem na versao atual do uuidtools nao encontrei o arquivo usesguid.rb mais algumas coisinhas, se possivel entrar em contato comigo, meu nole eh leonardo justino, <a href="mailto:leojustino@gmail.com">leojustino@gmail.com</a> <BR> <BR> - - Leo</p>
					<p class="postedBy">
					- - Posted in May 25, 2010 by <a href="../userHistory.pr%3FpostUser=189.7.26.2.html">189.7.26.2</a> 
										</p>
				</div>
			</div>	
		</div>	
		
				
</div>				

<div class="contentbox-full">
		<div id="divComment2"  style="display: none;">
		<a href="javascript:toggleVisibility('divComment');toggleVisibility('divComment2');">Add New Comment</a>
	</div>
	<h1>Add New Comment</h1>
	<div id="divComment">
		<form id="edit" name="edit" method="post" action="http://www.vitorpamplona.com/postComment.pr">
			<input type="hidden" name="keyword" value="UUID ou GUID em rails" />
			<p><textarea style="width:96%" name="commentOnlyText" id="commentOnlyText" rows=10></textarea></p>
							<p>Your Name: <input type="text" name="postUserName" value="" /></p>
						<p>
<img src="http://www.vitorpamplona.com/flood.jpg" /><br>
Write the code showed above on the text below.
<br>
<input class="inputText" type="text" id="floodValidation" name="floodValidation" value="" size=20/>
</p>
<p></p>			<p><input type="submit" name="Save" value="Save"></p>	
			<br>
		</form>	
	</div>
</div>	
				
	<script class='javascript'>  
 //<![CDATA[  
if (! window.ActiveXObject ) {
     function FindTagsByName(container, Tag)  
     {  
         var elements = document.getElementsByTagName(Tag);  
         for (var i = 0; i < elements.length; i++)  
         { 
		 if (elements[i].innerHTML.indexOf("def ") > -1
		 ||  elements[i].innerHTML.indexOf("ActiveR") > -1
		 ||  elements[i].innerHTML.indexOf("find_by") > -1	
                 ||  elements[i].innerHTML.indexOf(" => ") > -1
		 ) 
		    elements[i].setAttribute("class", "java");
                 else
		    elements[i].setAttribute("class","java");
		 elements[i].setAttribute("name", "code");
		 elements[i].setAttribute("id", "code");
                 container.push(elements[i]);  
         }  
     }  
     var elements = [];  
     FindTagsByName(elements, "pre");  

  for(var i=0; i < elements.length; i++) {  
   if(elements[i].nodeName.toUpperCase() == "PRE") {  
    brs = elements[i].getElementsByTagName("br");  
    for(var j = 0, brLength = brs.length; j < brLength; j++) {  
       var newNode = document.createTextNode("\n");  
       elements[i].replaceChild(newNode,brs[0]);  
    }  
   }  
  }  

}

   dp.SyntaxHighlighter.HighlightAll("code", false, false);  
 //]]>  
</script>     
	 <div id='pageshare' title="">
	<div class='sbutton' id='fb'>
        <script type="text/javascript">
           var url = window.location.href;
           document.write('<' + 'iframe src="http://www.facebook.com/plugins/like.php?href=' + url + '&send=false&layout=box_count&width=58&show_faces=true&action=like&colorscheme=light&font&height=65" scrolling="no" frameborder="0" style="border:none; overflow:hidden; width:58px; height:65px;" allowTransparency="true"></iframe>');
        </script>
	</div>
	
       <div class='sbutton' id='rt'>

       <script type="text/javascript">
           var url = window.location.href;
           document.write('<' + 'script type="text/javascript" src="http://button.topsy.com/widget/retweet-big?nick=vitorpamplona&url=' + url + '"></' + 'script>');
       </script>
		
	</div>

<div class='sbutton' id='gp'>
   <!-- Place this tag where you want the +1 button to render -->
   <g:plusone size="tall"></g:plusone>
<div>

	<div class='sbutton' id='gb'>
		<a class='google-buzz-button' data-button-style='normal-count' href='http://www.google.com/buzz/post' title='post on google buzz'>
			<script src='http://www.google.com/buzz/api/button.js' type='text/javascript'></script>
		</a>
	</div>


</div>                     

	</div>
		
    <!-- END WRAP CONTENT AND SIDEBAR -->
	</div>		

    <!-- FOOTER -->
    <div class="postedBy"></div>

    <div class="footer footer-font">
       <p><b>Copyright ©Vitor Pamplona | All Rights Reserved</b>  
       <br>Powered by <a href="http://wiki.com.br">Priki</a>. Visite os projetos: <a href="http://eyenetra.com">EyeNetra.com</a> e <a href="http://goblink.co">goBlink.co</a>.   

				- <a href="../showLogin.pr.html" class="selected">Login</a>
        	        	
	</p>
    </div>
  </div>
</body>
</html>
